<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/base}" th:with="activeMenu='usuarios'">

<head>
    <title>Usuarios</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Page Header -->
        <div th:replace="~{fragments/page-header :: page-header-simple('Gestión de Usuarios')}"></div>

        <!-- Barra de búsqueda y botones -->
        <div class="card card-dark mb-3">
            <div class="card-body">
                <form th:action="@{/usuarios}" method="get" class="row g-3">
                    <div class="col-md-10">
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">
                                <i class="fa fa-search"></i>
                            </span>
                            <input type="text" name="search" class="form-control form-control-dark"
                                placeholder="Buscar por nombre, DNI, usuario..." th:value="${param.search}">
                            <button class="btn btn-secondary" type="submit">
                                <i class="fa fa-search me-1"></i> Buscar
                            </button>
                            <a th:href="@{/usuarios}" class="btn btn-outline-light" th:if="${param.search}">
                                <i class="fa fa-times me-1"></i> Limpiar
                            </a>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <a th:href="@{/usuarios/crear}" class="btn btn-primary w-100">
                            <i class="fa fa-plus me-1"></i> Nuevo Usuario
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de usuarios -->
        <div class="card card-dark">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Nombre Completo</th>
                                <th>DNI</th>
                                <th>Roles</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.id}">1</td>
                                <td th:text="${usuario.username}">admin</td>
                                <td
                                    th:text="${usuario.apellidoPaterno + ' ' + usuario.apellidoMaterno + ', ' + usuario.nombres}">
                                    Nombre Apellido
                                </td>
                                <td th:text="${usuario.username}">12345678</td>
                                <!-- Nota: DTO no tiene DNI, usando username temporalmente -->
                                <td>
                                    <span th:each="rol : ${usuario.roles}" class="badge bg-info me-1" th:text="${rol}">
                                        Rol
                                    </span>
                                    <span th:if="${#lists.isEmpty(usuario.roles)}" class="text-muted">Sin roles</span>
                                </td>
                                <td>
                                    <span class="badge" th:classappend="${usuario.activo ? 'bg-success' : 'bg-danger'}"
                                        th:text="${usuario.activo ? 'Activo' : 'Inactivo'}">
                                        Activo
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/usuarios/editar/{id}(id=${usuario.id})}"
                                            class="btn btn-sm btn-outline-warning" title="Editar">
                                            <i class="fa fa-pencil"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger"
                                            th:attr="onclick='confirmarEliminar(' + ${usuario.id} + ', \'' + ${usuario.username} + '\')'"
                                            title="Eliminar">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${usuarios.empty}">
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fa fa-users fa-3x mb-3 d-block"></i>
                                    No hay usuarios registrados
                                    <span th:if="${param.search}">
                                        que coincidan con "<strong th:text="${param.search}"></strong>"
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Paginación -->
        <nav aria-label="Paginación de usuarios" class="mt-3 d-flex justify-content-center">
            <ul class="pagination pagination-dark">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/usuarios(page=${currentPage - 1}, search=${param.search})}"
                        aria-label="Anterior">
                        <span aria-hidden="true">&laquo; Anterior</span>
                    </a>
                </li>

                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/usuarios(page=${i}, search=${param.search})}"
                        th:text="${i + 1}">1</a>
                </li>

                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                    <a class="page-link" th:href="@{/usuarios(page=${currentPage + 1}, search=${param.search})}"
                        aria-label="Siguiente">
                        <span aria-hidden="true">Siguiente &raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Información de paginación -->
        <div class="text-center text-muted small mt-2" th:if="${!usuarios.empty}">
            Mostrando página <strong th:text="${currentPage + 1}">1</strong> de <strong
                th:text="${totalPages}">1</strong>
            (<strong th:text="${usuarios.size()}">0</strong> usuarios en esta página)
        </div>
    </div>

    <!-- Scripts específicos -->
    <th:block layout:fragment="scripts">
        <script>
            function confirmarEliminar(id, nombre) {
                if (confirm('¿Está seguro de eliminar al usuario "' + nombre + '"? Esta acción no se puede deshacer.')) {
                    // Aquí iría la lógica de eliminación
                    console.log('Eliminar usuario:', id);
                    // window.location.href = '/usuarios/eliminar/' + id;
                }
            }
        </script>
    </th:block>
</body>

</html>